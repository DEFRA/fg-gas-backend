name: Check Pull Request

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review

jobs:
  pr-validator:
    name: Run Pull Request Checks
    runs-on: self-hosted
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node version
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run unit tests
        run: npm run test:unit -- --coverage

      - name: Run integration tests
        run: DEBUG=testcontainers:containers npm run test:integration

      - name: Run contract tests
        env:
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
          GIT_COMMIT: ${{ github.sha }}
        run: |
          # Start services for contract testing
          LOCALSTACK_PORT=4567 MONGO_PORT=27018 GAS_PORT=3003 docker compose up --build -d

          # Wait for services to be ready
          sleep 15

          # Verify service health
          curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:3003/health

          # Run provider contract verification
          npm run test:contracts:provider

          # Clean up services
          docker compose down

      - name: Build docker image
        run: |
          set +e
          docker build --no-cache --tag fg-gas-backend .
          exit $?

#      - name: SonarCloud Scan
#        if: github.actor != 'dependabot[bot]'
#        uses: SonarSource/sonarcloud-github-action@master
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
